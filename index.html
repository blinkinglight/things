<!doctype html>
<html>
  <head>
    <script defer type="module">
      // ES6 modules can be natively used by set the script type
      // to "module". Now we can use native imports.
      import {
        connect,
        StringCodec,
        JSONCodec,
      } from "https://cdn.jsdelivr.net/npm/nats.ws@1.10.0/esm/nats.js";

      // Initialize a string codec for encoding and decoding message data.
      // This is because NATS message data are just byte arrays, so proper
      // encoding and decoding needs to be performed when using the working
      // with the message data.
      // See also JSONCodec.
      const sc = new StringCodec();
      const jc = JSONCodec();

      // Establish a connection to the NATS demo server. This uses the
      // native WebSocket support built into the NATS server.
      const nc = await connect({
        servers: ["ws://localhost:4443"],
      });

      // Subscribe to the "echo" subject and define a message
      // handler that will respond to the requester.
      // const sub = nc.subscribe("echo");
      const handle = (msg) => {
        console.log(`Received a request: ${sc.decode(msg.data)}`);
        msg.respond(msg.data);
      }

      // Wait to receive messages from the subscription and handle them
      // asynchronously..
      //(async () => {
        //for await (const msg of sub) handle(msg)
      //})();

      // Now we can send a couple requests to that subject. Note how we
      // are encoding the string data on request and decoding the reply
      // message data.
      //let rep = await nc.request("svc.post.create.command", sc.encode("Hello!"));
      //console.log(`Received a reply ok: ${sc.decode(rep.data)}`);

      // rep = await nc.request("svc.post.create.command", sc.encode("World!"));
      // console.log(`Received a reply: ${sc.decode(rep.data)}`);

      // Finally drain the connection which will handle any outstanding
      // messages before closing the connection.
      //nc.drain();
      
      
      
      window.send = async function(payload) {
        console.log("send", payload);
        let rep = await nc.request("svc.post.create.command", jc.encode(payload));
        console.log(`Received a reply ok: ${sc.decode(rep.data)}`);
      }
      window.login = async function() {
        let payload = {
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
        }
        let rep = await nc.request("svc.login", jc.encode(payload));
        let data = sc.decode(rep.data);
        console.log(`Received a reply ok: ${data}`);
        document.getElementById("response").innerHTML = data;
        data = JSON.parse(data);
        if(data.success) {
            document.getElementById("loginform").style.display = "none";
            document.getElementById("logoutform").style.display = "block";
        }
        if(data.message) {
            document.getElementById("message").innerHTML = data.message;
        }
      }
      window.logout = async function() {
        let rep = await nc.request("svc.logout", jc.encode({}));
        let data = sc.decode(rep.data);
        console.log(`Received a reply ok: ${data}`);
        document.getElementById("response").innerHTML = data;
        data = JSON.parse(data);
        if(data.success) {
            document.getElementById("loginform").style.display = "block";
            document.getElementById("logoutform").style.display = "none";
        }
        if(data.message) {
            document.getElementById("message").innerHTML = data.message;
        }
      }
    </script>
    <div id="message">

    </div>
    <div id="response">

    </div>
    <div id="loginform">
        <input type="username" id="username" placeholder="username" />
        <input type="password" id="password" placeholder="password" />
        <button onclick="login()">send</button>
    </div>
    <div id="logoutform" style="display:none">
        <button onclick="logout()">Logout</button>
    </div>
  </head>
</html>
